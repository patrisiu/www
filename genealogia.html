<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneaEditor Pro - Confort Visual & Biogr√°fico</title>
    <style>
        :root {
            --fondo: #f8fafc;
            --tarjeta: #ffffff;
            --texto-principal: #334155;
            --texto-secundario: #64748b;
            --borde: #e2e8f0;
            --accent: #475569;      /* Gris azulado c√≥modo */
            --accent-hover: #1e293b;
            --enfoque: #94a3b8;
            --m-color: #93c5fd;     /* Azul desaturado */
            --f-color: #f9a8d4;     /* Rosa desaturado */
            --peligro-suave: #fee2e2;
            --peligro-texto: #b91c1c;
            --sombra: 0 4px 12px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--fondo);
            margin: 0;
            color: var(--texto-principal);
            line-height: 1.6;
        }

        /* --- HEADER --- */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.8rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            border-bottom: 1px solid var(--borde);
        }

        .search-container { position: relative; flex-grow: 1; max-width: 400px; }
        #buscador {
            width: 100%; padding: 10px 16px; border: 1px solid var(--borde); border-radius: 10px;
            outline: none; background: #f1f5f9; font-size: 14px;
        }

        #resultados-busqueda {
            position: absolute; top: 105%; left: 0; right: 0; background: white;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); border-radius: 12px;
            max-height: 250px; overflow-y: auto; display: none; z-index: 110;
        }
        .res-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .res-item:hover { background: #f8fafc; color: var(--accent); }

        /* --- BOT√ìN RETORNO AL GRAFO (NUEVO) --- */
        .btn-grafo {
            text-decoration: none;
            background: #e2e8f0;
            color: var(--texto-principal);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            border: 1px solid var(--borde);
        }
        .btn-grafo:hover { background: #cbd5e1; transform: translateY(-1px); }

        /* --- ARBOL --- */
        #tree-container {
            display: flex; flex-direction: column; align-items: center; gap: 45px; padding: 60px 20px;
            background-image: radial-gradient(#e2e8f0 1.2px, transparent 1.2px);
            background-size: 32px 32px;
        }

        .nivel { display: flex; justify-content: center; gap: 28px; flex-wrap: wrap; width: 100%; }

        /* --- TARJETAS --- */
        .persona {
            width: 180px; background: var(--tarjeta); padding: 22px; border-radius: 20px;
            border: 1px solid var(--borde); text-align: center; cursor: pointer;
            transition: all 0.25s ease; box-shadow: var(--sombra); position: relative;
        }
        .persona:hover { transform: translateY(-3px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.08); }
        .persona.M { border-top: 5px solid var(--m-color); }
        .persona.F { border-top: 5px solid var(--f-color); }

        .persona.principal {
            outline: 3px solid var(--accent);
            outline-offset: 3px;
            transform: scale(1.05);
            box-shadow: 0 20px 25px -10px rgba(0,0,0,0.1);
        }

        .nombre { font-weight: 600; font-size: 1rem; display: block; margin-bottom: 4px; color: var(--texto-principal); }
        .fechas { font-size: 0.85rem; color: var(--texto-secundario); font-weight: 500; }

        .bloque-familiar {
            background: rgba(255, 255, 255, 0.4); padding: 35px; border-radius: 30px;
            border: 1.5px dashed var(--borde); display: flex; flex-direction: column;
            align-items: center; width: 100%; max-width: 920px; margin-top: 20px;
        }

        /* --- BOTONES --- */
        .btn {
            padding: 11px 22px; border-radius: 12px; border: none;
            cursor: pointer; font-weight: 600; font-size: 13px;
            transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
            background: var(--accent); color: white;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn-nav { background: #f1f5f9; color: var(--texto-principal); border: 1px solid var(--borde); }
        .btn-danger { background: var(--peligro-suave); color: var(--peligro-texto); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background: white; padding: 35px; border-radius: 24px; width: 90%; max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
        }
    </style>
</head>
<body>

<header class="header">
    <div style="display: flex; align-items: center; gap: 15px;">
        <a id="btn-retorno-grafo" href="graph.html" class="btn-grafo">üåê Vista Grafo</a>
        <h2 style="margin:0; font-size: 1.2rem; font-weight: 700; color: var(--accent);">GeneaEditor <span style="font-weight: 300; opacity: 0.7;">Pro</span></h2>
    </div>
    <div class="search-container">
        <input type="text" id="buscador" placeholder="Buscar pariente..." oninput="filtrarBusqueda()">
        <div id="resultados-busqueda"></div>
    </div>
    <div style="display:flex; gap:12px">
        <button class="btn btn-nav" onclick="document.getElementById('file-input').click()">Importar</button>
        <button class="btn btn-nav" onclick="exportarJSON()">Exportar</button>
        <button class="btn btn-danger" onclick="limpiarCache()">üóëÔ∏è</button>
    </div>
    <input type="file" id="file-input" style="display:none" onchange="importarJSON(event)">
</header>

<div id="tree-container"></div>

<div id="modal-editor" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-titulo" style="margin-top:0; color: var(--texto-principal);">Datos de la Persona</h3>
        <input type="hidden" id="edit-id">

        <div id="campos-persona">
            <div style="margin-bottom: 18px;">
                <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Nombre Completo</label>
                <input type="text" id="edit-nombre" style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box;">
            </div>

            <div style="display:flex; gap:12px; margin-bottom: 18px; flex-wrap: wrap;">
                <div style="flex:1; min-width: 100px;">
                    <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Nacimiento</label>
                    <input type="text" id="edit-nacimiento" placeholder="A√±o" style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box;">
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Defunci√≥n</label>
                    <input type="text" id="edit-defuncion" placeholder="A√±o" style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box;">
                </div>
                <div style="flex:1; min-width: 110px;">
                    <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Sexo</label>
                    <select id="edit-sexo" style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box;">
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Notas Biogr√°ficas</label>
                <textarea id="edit-notas" rows="4" placeholder="Historia, an√©cdotas..." style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box; font-family:inherit; resize:vertical;"></textarea>
            </div>
        </div>

        <div id="campos-union" style="display:none; margin-bottom: 20px;">
            <label style="display:block; font-size:12px; font-weight:700; color:var(--texto-secundario); margin-bottom:6px;">Vincular con</label>
            <select id="select-pareja-existente" style="width:100%; padding:12px; border:1px solid var(--borde); border-radius:8px; box-sizing:border-box;"></select>
        </div>

        <div style="display:flex; justify-content: space-between; margin-top:25px; border-top: 1px solid var(--borde); padding-top: 20px;">
            <button id="btn-eliminar" class="btn btn-danger" onclick="eliminarPersona()">Eliminar</button>
            <div style="display:flex; gap:12px;">
                <button class="btn btn-nav" onclick="cerrarModal()">Cancelar</button>
                <button class="btn" onclick="procesarGuardado()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    let datos = { personas: [], familias: [] };
    let idEnfoque = null;
    let modoModal = '';
    let contextID = null;

    window.addEventListener('DOMContentLoaded', () => {
        const guardado = localStorage.getItem('genealogia_db');
        const ultimoId = localStorage.getItem('genealogia_last_id');

        if (guardado) {
            datos = JSON.parse(guardado);

            // L√ìGICA DE DETECCI√ìN DE ID POR URL (GET)
            const urlParams = new URLSearchParams(window.location.search);
            const idUrl = urlParams.get('id');

            // Si hay ID en URL y existe en los datos, lo usamos. Si no, usamos el √∫ltimo o el primero.
            if (idUrl && datos.personas.some(p => p.id === idUrl)) {
                idEnfoque = idUrl;
            } else {
                idEnfoque = ultimoId || (datos.personas.length > 0 ? datos.personas[0].id : null);
            }

            actualizarBotonGrafo(idEnfoque);
            renderizar();
        }
    });

    // Funci√≥n para actualizar la URL del bot√≥n de retorno al grafo
    function actualizarBotonGrafo(id) {
        const btn = document.getElementById('btn-retorno-grafo');
        if (id) {
            btn.href = `graph.html?id=${id}`;
        }
    }

    function persistir() {
        localStorage.setItem('genealogia_db', JSON.stringify(datos));
        localStorage.setItem('genealogia_last_id', idEnfoque);
        actualizarBotonGrafo(idEnfoque);
    }

    function renderizar() {
        const contenedor = document.getElementById('tree-container');
        contenedor.innerHTML = '';
        if (datos.personas.length === 0) return;
        if (!idEnfoque) idEnfoque = datos.personas[0].id;
        const pPrincipal = datos.personas.find(p => p.id === idEnfoque);
        if (!pPrincipal) { idEnfoque = datos.personas[0].id; renderizar(); return; }

        // Actualizamos el enlace del grafo cada vez que el enfoque cambia
        actualizarBotonGrafo(idEnfoque);

        // 1. PADRES
        const divPadres = document.createElement('div');
        divPadres.className = 'nivel';
        const famHijo = datos.familias.find(f => f.hijos.includes(idEnfoque));
        if (famHijo) {
            if (famHijo.padre) divPadres.appendChild(crearNodo(famHijo.padre, "Padre"));
            if (famHijo.madre) divPadres.appendChild(crearNodo(famHijo.madre, "Madre"));
        }
        contenedor.appendChild(divPadres);

        // 2. CENTRAL
        const centralWrapper = document.createElement('div');
        centralWrapper.style.cssText = 'display:flex; flex-direction:column; align-items:center; width:100%;';
        const nodoP = crearNodo(idEnfoque, "Enfoque Actual");
        nodoP.querySelector('.persona').classList.add('principal');
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn';
        btnEdit.style.marginTop = '18px';
        btnEdit.innerHTML = 'üìù Editar Persona';
        btnEdit.onclick = abrirModalEdicion;
        nodoP.appendChild(btnEdit);
        centralWrapper.appendChild(nodoP);

        // UNIONES
        const fams = datos.familias.filter(f => f.padre === idEnfoque || f.madre === idEnfoque);
        fams.forEach(f => {
            const bloque = document.createElement('div');
            bloque.className = 'bloque-familiar';
            const filaU = document.createElement('div');
            filaU.className = 'nivel';
            filaU.style.alignItems = 'center';
            const conyugeId = f.padre === idEnfoque ? f.madre : f.padre;
            if(conyugeId) filaU.appendChild(crearNodo(conyugeId, "C√≥nyuge"));
            else filaU.innerHTML = '<div style="font-size:11px; color:#94a3b8; font-weight:700; text-transform:uppercase">Rama Monoparental</div>';
            const btnHijo = document.createElement('button');
            btnHijo.className = 'btn';
            btnHijo.style.marginTop = '24px';
            btnHijo.innerText = 'üë∂ A√±adir Hijo/a';
            btnHijo.onclick = () => abrirModalHijo(f.id);
            bloque.appendChild(filaU);
            bloque.appendChild(btnHijo);
            const divHijos = document.createElement('div');
            divHijos.className = 'nivel';
            divHijos.style.marginTop = '24px';
            f.hijos.forEach(hId => divHijos.appendChild(crearNodo(hId, "Hijo/a")));
            bloque.appendChild(divHijos);
            centralWrapper.appendChild(bloque);
        });

        const btnUnion = document.createElement('button');
        btnUnion.className = 'btn';
        btnUnion.style.marginTop = '40px';
        btnUnion.innerText = '‚ûï Nueva Uni√≥n o Rama';
        btnUnion.onclick = abrirModalUnion;
        centralWrapper.appendChild(btnUnion);
        contenedor.appendChild(centralWrapper);
    }

    function crearNodo(id, rol) {
        const p = datos.personas.find(x => x.id === id);
        if(!p) return document.createElement('div');
        const wrap = document.createElement('div');
        wrap.style.cssText = 'display:flex; flex-direction:column; align-items:center;';
        wrap.innerHTML = `<div style="font-size:10px; color:var(--texto-secundario); font-weight:800; text-transform:uppercase; margin-bottom:10px; letter-spacing:0.5px; text-align:center">${rol}</div>`;
        const div = document.createElement('div');
        div.className = `persona ${p.sexo}`;
        const fDisplay = p.defuncion ? `${p.nacimiento || '?'} - ${p.defuncion}` : (p.nacimiento || '---');
        div.innerHTML = `<span class="nombre">${p.nombre}</span><span class="fechas">${fDisplay}</span>`;
        div.onclick = () => { idEnfoque = id; persistir(); renderizar(); window.scrollTo({top:0, behavior:'smooth'}); };
        wrap.appendChild(div);
        return wrap;
    }

    // Funciones de modal, b√∫squeda e importaci√≥n permanecen iguales
    function abrirModalEdicion() {
        const p = datos.personas.find(x => x.id === idEnfoque);
        modoModal = 'EDITAR';
        document.getElementById('modal-titulo').innerText = "Editar Persona";
        document.getElementById('campos-persona').style.display = 'block';
        document.getElementById('campos-union').style.display = 'none';
        document.getElementById('btn-eliminar').style.display = 'block';
        document.getElementById('edit-nombre').value = p.nombre || '';
        document.getElementById('edit-nacimiento').value = p.nacimiento || '';
        document.getElementById('edit-defuncion').value = p.defuncion || '';
        document.getElementById('edit-sexo').value = p.sexo || 'M';
        document.getElementById('edit-notas').value = p.notas || '';
        document.getElementById('modal-editor').style.display = 'flex';
    }

    function abrirModalHijo(famId) {
        modoModal = 'HIJO'; contextID = famId;
        document.getElementById('modal-titulo').innerText = "Nuevo Hijo/a";
        document.getElementById('campos-persona').style.display = 'block';
        document.getElementById('campos-union').style.display = 'none';
        document.getElementById('btn-eliminar').style.display = 'none';
        document.getElementById('edit-nombre').value = "";
        document.getElementById('edit-nacimiento').value = "";
        document.getElementById('edit-defuncion').value = "";
        document.getElementById('edit-notas').value = "";
        document.getElementById('modal-editor').style.display = 'flex';
    }

    function abrirModalUnion() {
        modoModal = 'UNION';
        document.getElementById('modal-titulo').innerText = "Configurar Uni√≥n";
        document.getElementById('campos-persona').style.display = 'none';
        document.getElementById('campos-union').style.display = 'block';
        document.getElementById('btn-eliminar').style.display = 'none';
        const sel = document.getElementById('select-pareja-existente');
        sel.innerHTML = `<option value="NINGUNO">-- Solo hijos (Sin C√≥nyuge) --</option><option value="NUEVA">-- Crear Nueva Persona --</option>`;
        datos.personas.forEach(p => { if(p.id !== idEnfoque) sel.innerHTML += `<option value="${p.id}">${p.nombre}</option>`; });
        document.getElementById('modal-editor').style.display = 'flex';
    }

    function cerrarModal() { document.getElementById('modal-editor').style.display = 'none'; }

    function procesarGuardado() {
        if (modoModal === 'EDITAR' || modoModal === 'HIJO') {
            let p;
            if (modoModal === 'EDITAR') {
                p = datos.personas.find(x => x.id === idEnfoque);
            } else {
                const nuevoId = "I" + Date.now();
                p = { id: nuevoId };
                datos.personas.push(p);
                datos.familias.find(f => f.id === contextID).hijos.push(nuevoId);
            }
            p.nombre = document.getElementById('edit-nombre').value;
            p.sexo = document.getElementById('edit-sexo').value;
            p.nacimiento = document.getElementById('edit-nacimiento').value;
            p.defuncion = document.getElementById('edit-defuncion').value;
            p.notas = document.getElementById('edit-notas').value;
        } else if (modoModal === 'UNION') {
            const parejaId = document.getElementById('select-pareja-existente').value;
            let finalParejaId = null;
            if(parejaId === 'NUEVA') {
                finalParejaId = "I" + Date.now();
                const pCentral = datos.personas.find(x=>x.id===idEnfoque);
                datos.personas.push({ id: finalParejaId, nombre: "Nueva Pareja", sexo: pCentral.sexo === 'M' ? 'F' : 'M' });
            } else if (parejaId !== 'NINGUNO') { finalParejaId = parejaId; }
            datos.familias.push({ id: "F" + Date.now(), padre: (datos.personas.find(x=>x.id===idEnfoque).sexo === 'M' ? idEnfoque : finalParejaId), madre: (datos.personas.find(x=>x.id===idEnfoque).sexo === 'F' ? idEnfoque : finalParejaId), hijos: [] });
        }
        persistir(); cerrarModal(); renderizar();
    }

    function eliminarPersona() {
        if (!confirm("¬øEliminar permanentemente?")) return;
        const id = idEnfoque;
        datos.personas = datos.personas.filter(p => p.id !== id);
        datos.familias = datos.familias.filter(f => {
            if (f.padre === id) f.padre = null;
            if (f.madre === id) f.madre = null;
            f.hijos = f.hijos.filter(h => h !== id);
            return (f.padre || f.madre || f.hijos.length > 0);
        });
        idEnfoque = null; persistir(); cerrarModal(); renderizar();
    }

    function filtrarBusqueda() {
        const q = document.getElementById('buscador').value.toLowerCase();
        const res = document.getElementById('resultados-busqueda');
        if (q.length < 2) { res.style.display = 'none'; return; }
        const filtered = datos.personas.filter(p => p.nombre.toLowerCase().includes(q)).slice(0, 8);
        if (filtered.length > 0) {
            res.innerHTML = filtered.map(p => `<div class="res-item" onclick="saltarA('${p.id}')"><b>${p.nombre}</b></div>`).join('');
            res.style.display = 'block';
        } else { res.style.display = 'none'; }
    }

    function saltarA(id) { idEnfoque = id; document.getElementById('buscador').value = ''; document.getElementById('resultados-busqueda').style.display = 'none'; persistir(); renderizar(); }

    function importarJSON(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { datos = JSON.parse(ev.target.result); idEnfoque = datos.personas[0].id; persistir(); renderizar(); };
        reader.readAsText(e.target.files[0]);
    }

    function exportarJSON() {
        const blob = new Blob([JSON.stringify(datos, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'arbol_genealogico.json'; a.click();
    }

    function limpiarCache() { if(confirm("¬øBorrar todos los datos locales?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>