<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Genealog√≠a</title>
    <style>
        :root { --azul: #d1e9ff; --rosa: #ffd1e9; --borde: #444; --accent: #2c3e50; --peligro: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }

        .header { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .titulo-app { margin: 0; flex-grow: 1; font-size: 1.5rem; color: var(--accent); }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 12px; }
        .btn-import { background: #3498db; color: white; }
        .btn-export { background: #27ae60; color: white; }
        .btn-danger { background: var(--peligro); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Estructura del √Årbol */
        .tree { display: flex; justify-content: center; padding-top: 20px; overflow-x: auto; }
        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; }
        .tree li { text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid var(--borde); width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid var(--borde); }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid var(--borde); border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid var(--borde); width: 0; height: 20px; }

        /* Tarjetas */
        .nodo-familia { display: inline-flex; gap: 10px; background: #fff; padding: 12px; border: 2px solid var(--borde); border-radius: 12px; position: relative; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .persona { padding: 10px; border-radius: 8px; min-width: 150px; cursor: pointer; border: 1.5px solid #ccc; font-size: 13px; text-align: left; position: relative; transition: 0.2s; }
        .persona:hover { transform: scale(1.03); z-index: 101; }
        .persona.M { background: var(--azul); border-color: #3498db; }
        .persona.F { background: var(--rosa); border-color: #e91e63; }
        .persona strong { display: block; font-size: 14px; margin-bottom: 2px; }
        .persona .loc { display: block; font-size: 10px; color: #666; font-style: italic; margin-top: 2px; }

        /* Tooltip Mejorado para notas largas */
        .persona .tooltip {
            visibility: hidden; width: 280px; background-color: rgba(44, 62, 80, 0.98); color: #fff;
            text-align: left; border-radius: 8px; padding: 12px; position: absolute;
            z-index: 200; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0;
            transition: opacity 0.3s; font-size: 12px; pointer-events: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4); line-height: 1.4;
            max-height: 200px; overflow-y: auto; border: 1px solid #555;
        }
        .persona:hover .tooltip { visibility: visible; opacity: 1; }

        /* Modal */
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 0 100px rgba(0,0,0,0.4); z-index: 1000; width: 420px; }
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; backdrop-filter: blur(2px); }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .full-width { grid-column: span 2; }
    </style>
</head>
<body>

<div class="header">
    <h1 class="titulo-app">Genealog√≠a</h1>
    <button class="btn btn-import" onclick="document.getElementById('fileIn').click()">Importar JSON</button>
    <button class="btn btn-export" onclick="exportarJSON()">Copia de Seguridad</button>
    <button class="btn btn-danger" onclick="limpiarTodo()">Borrar √Årbol</button>
    <input type="file" id="fileIn" style="display:none" onchange="importarJSON(event)">
</div>

<div class="tree" id="tree-container"></div>

<div class="overlay" id="overlay" onclick="cerrarModal()"></div>
<div id="modal">
    <h3 style="margin:0 0 15px 0; color:var(--accent)">Ficha del Familiar</h3>
    <input type="hidden" id="edit-id">

    <label style="font-size:12px; font-weight:bold">Nombre y Apellidos:</label>
    <input type="text" id="edit-nombre">

    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label style="font-size:12px; font-weight:bold">Nacimiento:</label>
            <input type="text" id="edit-nac" placeholder="A√±o">
        </div>
        <div style="flex:1">
            <label style="font-size:12px; font-weight:bold">Lugar:</label>
            <input type="text" id="edit-lugar" placeholder="Ciudad">
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label style="font-size:12px; font-weight:bold">Defunci√≥n:</label>
            <input type="text" id="edit-def" placeholder="A√±o">
        </div>
        <div style="flex:1">
            <label style="font-size:12px; font-weight:bold">Sexo:</label>
            <select id="edit-sexo">
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
            </select>
        </div>
    </div>

    <label style="font-size:12px; font-weight:bold">Notas Biogr√°ficas:</label>
    <textarea id="edit-notas" rows="4" placeholder="Copia aqu√≠ toda la frase del .gen..."></textarea>

    <div class="modal-footer">
        <button class="btn btn-export full-width" onclick="guardarCambios()">GUARDAR CAMBIOS</button>
        <button class="btn btn-import" onclick="a√±adirHijo()">A√ëADIR HIJO/A</button>
        <button class="btn btn-import" id="btn-conyuge" onclick="a√±adirPareja()">A√ëADIR PAREJA</button>
        <button class="btn btn-danger full-width" onclick="confirmarBorrado()">ELIMINAR MIEMBRO</button>
    </div>
</div>

<script>
    // DATOS ACTUALIZADOS DESDE EL GEDCOM ORIGINAL
    let datos = {
        personas: [
            { id: "I1340797", nombre: "Jorge Sicilia Espuny", sexo: "M", nacimiento: "1974", lugar: "Burgos", notas: "Economista y padre de cuatro hijos. Casado con Susana." },
            { id: "I1340737", nombre: "Carmen Espuny Domingo", sexo: "F", nacimiento: "1940", lugar: "Tortosa", notas: "Farmac√©utica y madre de cinco hijos. Casada con Jes√∫s Sicilia Yllera." },
            { id: "I1340786", nombre: "Jesus Sicilia Yllera", sexo: "M", nacimiento: "1940", lugar: "Burgos, Espa√±a", notas: "Farmac√©utico y padre de cinco hijos. Casado con Carmen Espuny Domingo." },
            { id: "I1044438", nombre: "Carmen Espuny Aleixendri", sexo: "F", nacimiento: "1890", lugar: "Vinallop", notas: "Fue maestra hasta su jubilaci√≥n. Escribi√≥ una carta a todos sus hermanos comunicando su intenci√≥n de casarse... Carmen comenz√≥ los estudios en la prestigiosa ‚ÄúEscuela de Bibliotecarios‚Äù de Barcelona hacia 1920. No sabemos por qu√©, parece que el hecho de que la posibilidad de presentarse a oposiciones acabara a los 35 a√±os y ella ya hab√≠a cumplido los 30 tuvo algo que ver. Lluis-Nicolau d¬¥Olwe le dijo ‚ÄúSe√±orita Espuny siento mucho que nos deje‚Äù. La primera plaza que gan√≥ fue Berge (Teruel). Pronto pudo trasladarse a Bitem, al lado de Tortosa... En tiempos de la Rep√∫blica daba clases de catal√°n a la gente del pueblo. Acabada la guerra y con el marido en la c√°rcel hasta el 42... fue el √∫nico puntal econ√≥mico de la familia hasta que la hija mayor entr√≥ en Telef√≥nica el a√±o 43. Se jubil√≥ con 70 a√±os y muri√≥ a los 90 dejando una profunda huella." },
            { id: "I1340768", nombre: "Josep Espuny Domingo", sexo: "M", nacimiento: "1943", lugar: "Tortosa", notas: "Neix a Tortosa, estudia Batxillerat a Martos i la carrera d'Aparellador a Madrid. Altra vegada a Tortosa fa de professor de Batxillerat, UNED, EGB i ESO. Ara est√† ja jubilat." },
            { id: "I1340770", nombre: "Marinta Espuny Domingo", sexo: "F", nacimiento: "1954", lugar: "Tortosa", notas: "Licenciada en derecho y filosof√≠a y letras. Profesora de la Universidad Aut√≥noma de Barcelona. ¬øQui√©n ha sido el gracioso que ha puesto mi edad y curr√≠culum?" },
            { id: "I1044337", nombre: "Tomas Espuny Bonfill", sexo: "M", nacimiento: "1853", lugar: "Vinallop", notas: "Es el 7 de 8 hermanos. Carlista. Primero que cambia agricultura por industria. Se cas√≥ en Tortosa. El primer a√±o viv√≠an cada uno en las casa paternas, despu√©s vivieron en Vinallop y por √∫ltimo en Ferrerias. Muri√≥ paral√≠tico." },
            { id: "I1044338", nombre: "Cinta Aleixendri Bonfill", sexo: "F", nacimiento: "1857", lugar: "Espa√±a", notas: "Analfabeta, su mejor virtud era la discreci√≥n y el sentido com√∫n. Muy activa, era un archivo de refranero popular. Era la tercera." }
        ],
        familias: [
            { id: "F753344", padre: "I1340786", madre: "I1340737", hijos: ["I1340797"] },
            { id: "F753318", padre: "I1340710", madre: "I1340730", hijos: ["I1340737", "I1340768", "I1340770"] },
            { id: "F603221", padre: "I1044337", madre: "I1044338", hijos: ["I1044438"] }
        ]
    };

    const STORAGE_KEY = 'genealogia_v4_georef';

    window.onload = () => {
        const guardado = localStorage.getItem(STORAGE_KEY);
        if (guardado) {
            datos = JSON.parse(guardado);
        }
        renderizar();
    };

    function guardarYRenderizar() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
        renderizar();
    }

    function renderizar() {
        const contenedor = document.getElementById('tree-container');
        contenedor.innerHTML = '';
        const idHijos = new Set();
        datos.familias.forEach(f => f.hijos.forEach(id => idHijos.add(id)));
        const familiasRaiz = datos.familias.filter(f => !idHijos.has(f.padre) && !idHijos.has(f.madre));

        const ul = document.createElement('ul');
        if(familiasRaiz.length > 0) {
            familiasRaiz.forEach(fam => ul.appendChild(dibujarNodoFamilia(fam)));
        } else {
            datos.personas.forEach(p => {
                const li = document.createElement('li');
                li.appendChild(crearTarjetaPersona(p));
                ul.appendChild(li);
            });
        }
        contenedor.appendChild(ul);
    }

    function dibujarNodoFamilia(fam) {
        const li = document.createElement('li');
        const divFam = document.createElement('div');
        divFam.className = 'nodo-familia';

        const p = datos.personas.find(x => x.id === fam.padre);
        const m = datos.personas.find(x => x.id === fam.madre);

        if(p) divFam.appendChild(crearTarjetaPersona(p));
        if(m) divFam.appendChild(crearTarjetaPersona(m));
        li.appendChild(divFam);

        if (fam.hijos && fam.hijos.length > 0) {
            const ulHijos = document.createElement('ul');
            fam.hijos.forEach(hId => {
                const subFam = datos.familias.find(f => f.padre === hId || f.madre === hId);
                if (subFam) ulHijos.appendChild(dibujarNodoFamilia(subFam));
                else {
                    const hijo = datos.personas.find(x => x.id === hId);
                    if(hijo) {
                        const liH = document.createElement('li');
                        liH.appendChild(crearTarjetaPersona(hijo));
                        ulHijos.appendChild(liH);
                    }
                }
            });
            li.appendChild(ulHijos);
        }
        return li;
    }

    function crearTarjetaPersona(p) {
        const div = document.createElement('div');
        div.className = `persona ${p.sexo}`;
        const def = p.defuncion ? ` - ‚Ä† ${p.defuncion}` : '';
        const lugarStr = p.lugar ? `<span class="loc">üìç ${p.lugar}</span>` : '';

        div.innerHTML = `<strong>${p.nombre}</strong><small>n. ${p.nacimiento || '?'}${def}</small>${lugarStr}`;
        
        if(p.notas) {
            const tt = document.createElement('span');
            tt.className = 'tooltip';
            tt.innerText = p.notas;
            div.appendChild(tt);
        }

        div.onclick = (e) => { e.stopPropagation(); abrirModal(p.id); };
        return div;
    }

    function abrirModal(id) {
        const p = datos.personas.find(x => x.id === id);
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-nombre').value = p.nombre;
        document.getElementById('edit-sexo').value = p.sexo;
        document.getElementById('edit-nac').value = p.nacimiento || '';
        document.getElementById('edit-lugar').value = p.lugar || '';
        document.getElementById('edit-def').value = p.defuncion || '';
        document.getElementById('edit-notas').value = p.notas || '';
        
        const tienePareja = datos.familias.some(f => (f.padre === id && f.madre !== null) || (f.madre === id && f.padre !== null));
        document.getElementById('btn-conyuge').style.display = tienePareja ? 'none' : 'inline-block';

        document.getElementById('modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function guardarCambios() {
        const p = datos.personas.find(x => x.id === document.getElementById('edit-id').value);
        p.nombre = document.getElementById('edit-nombre').value;
        p.sexo = document.getElementById('edit-sexo').value;
        p.nacimiento = document.getElementById('edit-nac').value;
        p.lugar = document.getElementById('edit-lugar').value;
        p.defuncion = document.getElementById('edit-def').value;
        p.notas = document.getElementById('edit-notas').value;
        cerrarModal(); guardarYRenderizar();
    }

    // Funciones de utilidad (Hijo, Pareja, Exportaci√≥n) mantenidas de la v4...
    function a√±adirHijo() {
        const idActual = document.getElementById('edit-id').value;
        const pActual = datos.personas.find(x => x.id === idActual);
        let fam = datos.familias.find(f => f.padre === idActual || f.madre === idActual);
        if(!fam) {
            fam = { id: "F_" + Date.now(), padre: pActual.sexo === 'M' ? idActual : null, madre: pActual.sexo === 'F' ? idActual : null, hijos: [] };
            datos.familias.push(fam);
        }
        const nom = prompt("Nombre del hijo/a:");
        if(!nom) return;
        const sexo = prompt("Sexo (M/F):", "M").toUpperCase() === 'F' ? 'F' : 'M';
        const nuevoId = "H_" + Date.now();
        datos.personas.push({id: nuevoId, nombre: nom, sexo: sexo, nacimiento: '', lugar: '', notas: ''});
        fam.hijos.push(nuevoId);
        cerrarModal(); guardarYRenderizar();
    }

    function a√±adirPareja() {
        const idActual = document.getElementById('edit-id').value;
        const pActual = datos.personas.find(x => x.id === idActual);
        const nom = prompt("Nombre de la pareja:");
        if(!nom) return;
        const sexo = pActual.sexo === 'M' ? 'F' : 'M';
        const nuevoId = "P_" + Date.now();
        datos.personas.push({id: nuevoId, nombre: nom, sexo: sexo, nacimiento: '', lugar: '', notas: ''});
        let fam = datos.familias.find(f => f.padre === idActual || f.madre === idActual);
        if(fam) { if(sexo === 'M') fam.padre = nuevoId; else fam.madre = nuevoId; }
        else { datos.familias.push({ id: "F_" + Date.now(), padre: sexo === 'M' ? nuevoId : idActual, madre: sexo === 'F' ? nuevoId : idActual, hijos: [] }); }
        cerrarModal(); guardarYRenderizar();
    }

    function confirmarBorrado() {
        const id = document.getElementById('edit-id').value;
        if(confirm("¬øEliminar a este miembro?")) {
            datos.personas = datos.personas.filter(x => x.id !== id);
            datos.familias.forEach(f => { f.hijos = f.hijos.filter(hId => hId !== id); if(f.padre === id) f.padre = null; if(f.madre === id) f.madre = null; });
            datos.familias = datos.familias.filter(f => f.padre !== null || f.madre !== null || f.hijos.length > 0);
            cerrarModal(); guardarYRenderizar();
        }
    }

    function cerrarModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function exportarJSON() {
        const blob = new Blob([JSON.stringify(datos, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'sicilia_espuny_completo.json'; a.click();
    }
    function importarJSON(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { datos = JSON.parse(ev.target.result); guardarYRenderizar(); };
        reader.readAsText(e.target.files[0]);
    }
    function limpiarTodo() { if(confirm("¬øBorrar todo?")) { datos = { personas: [], familias: [] }; localStorage.clear(); renderizar(); } }
</script>
</body>
</html>